# Icon Hunter Dockerfile - Alpineä¼˜åŒ–ç‰ˆæœ¬
# é€‚åˆå›½å†…ç”¨æˆ·çš„æœ€å°åŒ–æ„å»º

# ==========================================
# ä¾èµ–å®‰è£…é˜¶æ®µ
# ==========================================
FROM node:18-alpine AS deps

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# è®¾ç½®npmé•œåƒæºå¹¶å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com && \
    npm ci --frozen-lockfile --production=false && \
    npm cache clean --force

# ==========================================
# æ„å»ºé˜¶æ®µ
# ==========================================
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules

# å¤åˆ¶æºä»£ç å’Œæ„å»ºé…ç½®
COPY . .

# è¯»å– .env.build æ–‡ä»¶å¹¶æ„å»ºåº”ç”¨
RUN echo "ğŸ”§ å¼€å§‹æ„å»ºè¿‡ç¨‹..." && \
    if [ -f .env.build ]; then \
        echo "ğŸ“‹ è¯»å–æ„å»ºé…ç½®æ–‡ä»¶..." && \
        export $(cat .env.build | grep -v '^#' | grep -v '^[[:space:]]*$' | xargs) && \
        echo "âœ… æ„å»ºé…ç½®:" && \
        echo "   NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL" && \
        echo "   NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" && \
        echo "   NEXT_PUBLIC_GA_ID=$NEXT_PUBLIC_GA_ID" && \
        echo "   NEXT_PUBLIC_BAIDU_ANALYTICS_ID=$NEXT_PUBLIC_BAIDU_ANALYTICS_ID"; \
    else \
        echo "âš ï¸  è­¦å‘Š: .env.build æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®" && \
        export NODE_ENV=production && \
        export NEXT_TELEMETRY_DISABLED=1; \
    fi && \
    echo "ğŸš€ å¼€å§‹æ„å»ºåº”ç”¨..." && \
    npm run build && \
    echo "ğŸ§¹ æ¸…ç†æ„å»ºé…ç½®æ–‡ä»¶..." && \
    rm -f .env.build && \
    echo "âœ… æ„å»ºå®Œæˆ!"

# ==========================================
# è¿è¡Œé˜¶æ®µ - æœ€å°Alpine
# ==========================================
FROM node:18-alpine AS runner

# åªå®‰è£…å¿…è¦çš„è¿è¡Œæ—¶
RUN apk add --no-cache tini

WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# å¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000

# ä½¿ç”¨tiniä½œä¸ºinitè¿›ç¨‹ï¼Œæé«˜ä¿¡å·å¤„ç†
ENTRYPOINT ["/sbin/tini", "--"]

# å¯åŠ¨åº”ç”¨
CMD ["node", "server.js"] 